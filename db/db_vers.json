{
  "currentVersion": 15,
  "versions": {
    "0": {
      "description": "Initial schema - subjects owned by users",
      "schema": {
        "subjects": {
          "columns": ["id", "user_id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are tied to users via user_id foreign key"
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions"
        }
      }
    },
    "1": {
      "description": "Workspace architecture - subjects are public, users have workspaces",
      "schema": {
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are standalone content, not tied to users. All subjects are publicly accessible."
        },
        "user_workspaces": {
          "columns": ["id", "user_id", "subject_id", "is_creator", "added_at"],
          "note": "Links users to subjects in their workspace. is_creator=1 means user created this subject."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions (unchanged)"
        }
      },
      "migration": {
        "from": 0,
        "steps": [
          {
            "action": "create_table",
            "table": "user_workspaces",
            "sql": "CREATE TABLE IF NOT EXISTS user_workspaces (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, is_creator INTEGER DEFAULT 0, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, UNIQUE(user_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_user_id ON user_workspaces(user_id)"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_subject_id ON user_workspaces(subject_id)"
          },
          {
            "action": "migrate_data",
            "description": "Migrate existing subjects to workspace model - create workspace entries for subject creators",
            "sql": "INSERT INTO user_workspaces (user_id, subject_id, is_creator, added_at) SELECT user_id, id, 1, created_at FROM subjects"
          },
          {
            "action": "drop_column_simulation",
            "description": "SQLite doesn't support DROP COLUMN directly, so we recreate the table",
            "steps": [
              "CREATE TABLE subjects_new (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, syllabus_content TEXT, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()))",
              "INSERT INTO subjects_new (id, name, syllabus_content, created_at, updated_at) SELECT id, name, syllabus_content, created_at, updated_at FROM subjects",
              "DROP TABLE subjects",
              "ALTER TABLE subjects_new RENAME TO subjects"
            ]
          },
          {
            "action": "recreate_indexes",
            "description": "Recreate indexes after table recreation",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_name ON subjects(name)"
          }
        ]
      }
    },
    "2": {
      "description": "Add score_history to user_progress for last-3-scores averaging with 50% starting score",
      "schema": {
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "updated_at"],
          "note": "score_history stores JSON array of last 3 scores (out of 10). Default starting score is 50%, averaging with last 3 attempts."
        }
      },
      "migration": {
        "from": 1,
        "steps": [
          {
            "action": "create_table",
            "description": "Add score_history column to user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN score_history TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "3": {
      "description": "Markscheme-based objective tracking system - adds markschemes table, solution objectives to questions, and completed objectives tracking",
      "schema": {
        "markschemes": {
          "columns": ["id", "subject_id", "name", "content", "created_at"],
          "note": "Stores markscheme files for papers, used to extract solution objectives"
        },
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "created_at"],
          "note": "solution_objectives stores JSON array of marking criteria/objectives. markscheme_id references the source markscheme."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "completed_objectives", "updated_at"],
          "note": "completed_objectives stores JSON array of objective indices that user has achieved. Once set, objectives cannot be removed (immutable progress)."
        }
      },
      "migration": {
        "from": 2,
        "steps": [
          {
            "action": "create_table",
            "table": "markschemes",
            "sql": "CREATE TABLE IF NOT EXISTS markschemes (id INTEGER PRIMARY KEY AUTOINCREMENT, subject_id INTEGER NOT NULL, name TEXT NOT NULL, content TEXT NOT NULL, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "markschemes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_markschemes_subject_id ON markschemes(subject_id)"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN solution_objectives TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN markscheme_id INTEGER REFERENCES markschemes(id) ON DELETE SET NULL"
          },
          {
            "action": "add_column",
            "table": "user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN completed_objectives TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "4": {
      "description": "Add paper_date and question_number to questions for separate paper/markscheme workflow",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "created_at"],
          "note": "paper_date stores exam date (e.g., '2022-06'), question_number stores question identifier (e.g., '1-3-5')"
        }
      },
      "migration": {
        "from": 3,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN paper_date TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN question_number TEXT"
          }
        ]
      }
    },
    "5": {
      "description": "Teacher-student class system - adds classes, class memberships, and class-subject assignments",
      "schema": {
        "classes": {
          "columns": ["id", "name", "description", "teacher_id", "classroom_code", "created_at", "updated_at"],
          "note": "Classes created by teachers with unique 6-character codes"
        },
        "class_memberships": {
          "columns": ["id", "class_id", "user_id", "role", "status", "joined_at"],
          "note": "Tracks teacher/student membership in classes with pending/approved/rejected status"
        },
        "class_subjects": {
          "columns": ["id", "class_id", "subject_id", "added_by_user_id", "added_at"],
          "note": "Links subjects to classes so students can access them"
        },
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "class_id", "created_at", "updated_at"],
          "note": "Subjects can optionally belong to a specific class (class_id)"
        }
      },
      "migration": {
        "from": 4,
        "steps": [
          {
            "action": "create_table",
            "table": "classes",
            "sql": "CREATE TABLE IF NOT EXISTS classes (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, description TEXT, teacher_id INTEGER NOT NULL, classroom_code TEXT UNIQUE NOT NULL, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (teacher_id) REFERENCES users(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "classes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_classes_teacher_id ON classes(teacher_id)"
          },
          {
            "action": "create_index",
            "table": "classes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_classes_classroom_code ON classes(classroom_code)"
          },
          {
            "action": "create_table",
            "table": "class_memberships",
            "sql": "CREATE TABLE IF NOT EXISTS class_memberships (id INTEGER PRIMARY KEY AUTOINCREMENT, class_id INTEGER NOT NULL, user_id INTEGER NOT NULL, role TEXT NOT NULL CHECK(role IN ('teacher', 'student')), status TEXT NOT NULL CHECK(status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending', joined_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, UNIQUE(class_id, user_id))"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_class_id ON class_memberships(class_id)"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_user_id ON class_memberships(user_id)"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_status ON class_memberships(status)"
          },
          {
            "action": "create_table",
            "table": "class_subjects",
            "sql": "CREATE TABLE IF NOT EXISTS class_subjects (id INTEGER PRIMARY KEY AUTOINCREMENT, class_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, added_by_user_id INTEGER NOT NULL, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, FOREIGN KEY (added_by_user_id) REFERENCES users(id) ON DELETE CASCADE, UNIQUE(class_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "class_subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_subjects_class_id ON class_subjects(class_id)"
          },
          {
            "action": "create_index",
            "table": "class_subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_subjects_subject_id ON class_subjects(subject_id)"
          },
          {
            "action": "add_column",
            "table": "subjects",
            "sql": "ALTER TABLE subjects ADD COLUMN class_id INTEGER DEFAULT NULL"
          },
          {
            "action": "create_index",
            "table": "subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_class_id ON subjects(class_id)"
          }
        ]
      }
    },
    "6": {
      "description": "Add diagram_mermaid to questions for mermaid diagram support",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "diagram_mermaid", "created_at"],
          "note": "diagram_mermaid stores mermaid diagram syntax for rendering diagrams"
        }
      },
      "migration": {
        "from": 5,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN diagram_mermaid TEXT"
          }
        ]
      }
    },
    "7": {
      "description": "Add categorization confidence and reasoning for improved paper categorization accuracy",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "diagram_mermaid", "categorization_confidence", "categorization_reasoning", "created_at"],
          "note": "categorization_confidence stores confidence score (0-100) for AI categorization decisions, categorization_reasoning stores brief explanation"
        }
      },
      "migration": {
        "from": 6,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN categorization_confidence INTEGER DEFAULT 100"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN categorization_reasoning TEXT"
          }
        ]
      }
    },
    "8": {
      "description": "Add user feedback system with admin dashboard",
      "schema": {
        "feedback": {
          "columns": ["id", "user_id", "category", "title", "description", "url", "screenshot_url", "browser_info", "status", "priority", "created_at", "updated_at", "resolved_at"],
          "note": "Main feedback table storing bug reports, feature requests, and user inquiries. Supports anonymous and authenticated users."
        },
        "feedback_notes": {
          "columns": ["id", "feedback_id", "admin_user_id", "note", "is_internal", "created_at"],
          "note": "Admin notes on feedback items. is_internal=1 hides note from users."
        },
        "feedback_status_history": {
          "columns": ["id", "feedback_id", "admin_user_id", "old_status", "new_status", "changed_at"],
          "note": "Tracks all status changes for feedback items for audit trail."
        }
      },
      "migration": {
        "from": 7,
        "steps": [
          {
            "action": "create_table",
            "table": "feedback",
            "sql": "CREATE TABLE IF NOT EXISTS feedback (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, category TEXT NOT NULL CHECK(category IN ('bug', 'feature', 'improvement', 'question', 'other')), title TEXT NOT NULL, description TEXT NOT NULL, url TEXT, screenshot_url TEXT, browser_info TEXT, status TEXT NOT NULL DEFAULT 'new' CHECK(status IN ('new', 'in_progress', 'resolved', 'closed', 'archived')), priority TEXT DEFAULT 'medium' CHECK(priority IN ('low', 'medium', 'high', 'critical')), created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), resolved_at INTEGER, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_user_id ON feedback(user_id)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_status ON feedback(status)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_category ON feedback(category)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_created_at ON feedback(created_at)"
          },
          {
            "action": "create_table",
            "table": "feedback_notes",
            "sql": "CREATE TABLE IF NOT EXISTS feedback_notes (id INTEGER PRIMARY KEY AUTOINCREMENT, feedback_id INTEGER NOT NULL, admin_user_id INTEGER NOT NULL, note TEXT NOT NULL, is_internal BOOLEAN DEFAULT 1, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE, FOREIGN KEY (admin_user_id) REFERENCES users(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "feedback_notes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_notes_feedback_id ON feedback_notes(feedback_id)"
          },
          {
            "action": "create_table",
            "table": "feedback_status_history",
            "sql": "CREATE TABLE IF NOT EXISTS feedback_status_history (id INTEGER PRIMARY KEY AUTOINCREMENT, feedback_id INTEGER NOT NULL, admin_user_id INTEGER, old_status TEXT, new_status TEXT NOT NULL, changed_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE, FOREIGN KEY (admin_user_id) REFERENCES users(id) ON DELETE SET NULL)"
          },
          {
            "action": "create_index",
            "table": "feedback_status_history",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_status_history_feedback_id ON feedback_status_history(feedback_id)"
          }
        ]
      }
    },
    "9": {
      "description": "Transition version - no migration needed (feedback system already applied)",
      "schema": {},
      "migration": {
        "from": 8,
        "steps": []
      }
    },
    "10": {
      "description": "Add email verification system - replaces manual approval with automated email verification",
      "schema": {
        "users": {
          "columns": ["id", "name", "email", "email_verified", "image", "access_level", "email_verification_sent_at", "created_at", "updated_at"],
          "note": "email_verification_sent_at stores timestamp of last verification email sent (for rate limiting)"
        }
      },
      "migration": {
        "from": 9,
        "steps": [
          {
            "action": "add_column",
            "table": "users",
            "sql": "ALTER TABLE users ADD COLUMN email_verification_sent_at INTEGER DEFAULT NULL"
          }
        ]
      }
    },
    "11": {
      "description": "Add careers pathway planning system - brainstorming, university goals, and personalized pathways",
      "schema": {
        "career_sessions": {
          "columns": ["id", "user_id", "session_type", "cv_file_path", "cv_parsed_data", "current_school", "current_year_group", "target_application_year", "use_exammer_data", "brainstorm_complete", "created_at", "updated_at"],
          "note": "Main session container for career planning. session_type: 'explore' or 'direct'"
        },
        "brainstorm_nodes": {
          "columns": ["id", "session_id", "node_id", "parent_node_id", "label", "level", "selected", "position_x", "position_y", "created_at"],
          "note": "Interactive mindmap nodes. node_id is React Flow ID, level 0 = root question"
        },
        "career_goals": {
          "columns": ["id", "session_id", "university_name", "course_name", "entry_requirements", "typical_offer", "university_url", "is_primary", "ai_confidence_score", "created_at", "updated_at"],
          "note": "University/course goals. entry_requirements is JSON object"
        },
        "pathways": {
          "columns": ["id", "goal_id", "pathway_name", "pathway_type", "description", "generation_prompt", "is_active", "created_at", "updated_at"],
          "note": "Generated pathways. pathway_type: 'primary', 'alternative', 'regenerated'"
        },
        "pathway_milestones": {
          "columns": ["id", "pathway_id", "milestone_month", "milestone_year", "milestone_type", "title", "description", "status", "completion_notes", "completed_at", "order_index"],
          "note": "Month-by-month milestones. milestone_type: 'academic', 'extracurricular', 'application', 'general'. status: 'pending', 'in_progress', 'completed', 'failed', 'skipped'"
        },
        "subject_grade_targets": {
          "columns": ["id", "pathway_id", "subject_name", "current_grade", "target_grade", "current_percentage", "target_percentage", "priority", "notes"],
          "note": "Per-subject grade targets. priority: 'low', 'medium', 'high', 'critical'"
        },
        "topic_improvement_links": {
          "columns": ["id", "milestone_id", "subject_name", "topic_id", "topic_name", "topic_description", "improvement_reason", "current_score", "target_score", "exammer_link"],
          "note": "Links Exammer topics to pathway milestones. topic_id may be NULL if topic doesn't exist yet"
        },
        "pathway_regeneration_history": {
          "columns": ["id", "pathway_id", "regeneration_reason", "failed_milestone_ids", "prompt_adjustments", "created_at"],
          "note": "Tracks pathway adaptations. failed_milestone_ids is JSON array"
        }
      },
      "migration": {
        "from": 10,
        "steps": [
          {
            "action": "create_table",
            "table": "career_sessions",
            "sql": "CREATE TABLE IF NOT EXISTS career_sessions (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, session_type TEXT NOT NULL CHECK(session_type IN ('explore', 'direct')), cv_file_path TEXT, cv_parsed_data TEXT, current_school TEXT, current_year_group TEXT, target_application_year INTEGER, use_exammer_data INTEGER DEFAULT 0, brainstorm_complete INTEGER DEFAULT 0, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "career_sessions",
            "sql": "CREATE INDEX IF NOT EXISTS idx_career_sessions_user_id ON career_sessions(user_id)"
          },
          {
            "action": "create_table",
            "table": "brainstorm_nodes",
            "sql": "CREATE TABLE IF NOT EXISTS brainstorm_nodes (id INTEGER PRIMARY KEY AUTOINCREMENT, session_id INTEGER NOT NULL, node_id TEXT UNIQUE NOT NULL, parent_node_id TEXT, label TEXT NOT NULL, level INTEGER NOT NULL, selected INTEGER DEFAULT 0, position_x REAL NOT NULL, position_y REAL NOT NULL, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (session_id) REFERENCES career_sessions(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "brainstorm_nodes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_brainstorm_nodes_session_id ON brainstorm_nodes(session_id)"
          },
          {
            "action": "create_index",
            "table": "brainstorm_nodes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_brainstorm_nodes_parent ON brainstorm_nodes(parent_node_id)"
          },
          {
            "action": "create_table",
            "table": "career_goals",
            "sql": "CREATE TABLE IF NOT EXISTS career_goals (id INTEGER PRIMARY KEY AUTOINCREMENT, session_id INTEGER NOT NULL, university_name TEXT NOT NULL, course_name TEXT NOT NULL, entry_requirements TEXT, typical_offer TEXT, university_url TEXT, is_primary INTEGER DEFAULT 0, ai_confidence_score INTEGER, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (session_id) REFERENCES career_sessions(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "career_goals",
            "sql": "CREATE INDEX IF NOT EXISTS idx_career_goals_session_id ON career_goals(session_id)"
          },
          {
            "action": "create_table",
            "table": "pathways",
            "sql": "CREATE TABLE IF NOT EXISTS pathways (id INTEGER PRIMARY KEY AUTOINCREMENT, goal_id INTEGER NOT NULL, pathway_name TEXT NOT NULL, pathway_type TEXT NOT NULL CHECK(pathway_type IN ('primary', 'alternative', 'regenerated')), description TEXT, generation_prompt TEXT, is_active INTEGER DEFAULT 1, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (goal_id) REFERENCES career_goals(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "pathways",
            "sql": "CREATE INDEX IF NOT EXISTS idx_pathways_goal_id ON pathways(goal_id)"
          },
          {
            "action": "create_table",
            "table": "pathway_milestones",
            "sql": "CREATE TABLE IF NOT EXISTS pathway_milestones (id INTEGER PRIMARY KEY AUTOINCREMENT, pathway_id INTEGER NOT NULL, milestone_month INTEGER NOT NULL, milestone_year INTEGER NOT NULL, milestone_type TEXT NOT NULL CHECK(milestone_type IN ('academic', 'extracurricular', 'application', 'general')), title TEXT NOT NULL, description TEXT NOT NULL, status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'in_progress', 'completed', 'failed', 'skipped')), completion_notes TEXT, completed_at INTEGER, order_index INTEGER NOT NULL, FOREIGN KEY (pathway_id) REFERENCES pathways(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "pathway_milestones",
            "sql": "CREATE INDEX IF NOT EXISTS idx_pathway_milestones_pathway_id ON pathway_milestones(pathway_id)"
          },
          {
            "action": "create_index",
            "table": "pathway_milestones",
            "sql": "CREATE INDEX IF NOT EXISTS idx_pathway_milestones_month ON pathway_milestones(milestone_month, milestone_year)"
          },
          {
            "action": "create_table",
            "table": "subject_grade_targets",
            "sql": "CREATE TABLE IF NOT EXISTS subject_grade_targets (id INTEGER PRIMARY KEY AUTOINCREMENT, pathway_id INTEGER NOT NULL, subject_name TEXT NOT NULL, current_grade TEXT, target_grade TEXT NOT NULL, current_percentage INTEGER, target_percentage INTEGER NOT NULL, priority TEXT NOT NULL DEFAULT 'medium' CHECK(priority IN ('low', 'medium', 'high', 'critical')), notes TEXT, FOREIGN KEY (pathway_id) REFERENCES pathways(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "subject_grade_targets",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subject_grade_targets_pathway_id ON subject_grade_targets(pathway_id)"
          },
          {
            "action": "create_table",
            "table": "topic_improvement_links",
            "sql": "CREATE TABLE IF NOT EXISTS topic_improvement_links (id INTEGER PRIMARY KEY AUTOINCREMENT, milestone_id INTEGER NOT NULL, subject_name TEXT NOT NULL, topic_id INTEGER, topic_name TEXT NOT NULL, topic_description TEXT, improvement_reason TEXT, current_score INTEGER, target_score INTEGER NOT NULL, exammer_link TEXT, FOREIGN KEY (milestone_id) REFERENCES pathway_milestones(id) ON DELETE CASCADE, FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE SET NULL)"
          },
          {
            "action": "create_index",
            "table": "topic_improvement_links",
            "sql": "CREATE INDEX IF NOT EXISTS idx_topic_improvement_links_milestone_id ON topic_improvement_links(milestone_id)"
          },
          {
            "action": "create_index",
            "table": "topic_improvement_links",
            "sql": "CREATE INDEX IF NOT EXISTS idx_topic_improvement_links_topic_id ON topic_improvement_links(topic_id)"
          },
          {
            "action": "create_table",
            "table": "pathway_regeneration_history",
            "sql": "CREATE TABLE IF NOT EXISTS pathway_regeneration_history (id INTEGER PRIMARY KEY AUTOINCREMENT, pathway_id INTEGER NOT NULL, regeneration_reason TEXT NOT NULL, failed_milestone_ids TEXT, prompt_adjustments TEXT, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (pathway_id) REFERENCES pathways(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "pathway_regeneration_history",
            "sql": "CREATE INDEX IF NOT EXISTS idx_pathway_regeneration_history_pathway_id ON pathway_regeneration_history(pathway_id)"
          }
        ]
      }
    },
    "12": {
      "description": "Fix careers pathway schema mismatches - align database schema with API code expectations",
      "schema": {
        "brainstorm_nodes": {
          "columns": ["id", "session_id", "node_id", "parent_node_id", "label", "level", "selected", "is_root", "position_x", "position_y", "created_at"],
          "note": "Added is_root column to distinguish root question from child nodes"
        },
        "career_goals": {
          "columns": ["id", "session_id", "university_name", "course_name", "entry_requirements", "required_subjects", "typical_offer", "university_url", "is_primary", "ai_confidence_score", "created_at", "updated_at"],
          "note": "Added required_subjects column (JSON array) for course prerequisites"
        },
        "pathways": {
          "columns": ["id", "goal_id", "title", "overview_summary", "application_timeline", "created_at", "updated_at"],
          "note": "Renamed pathway_name→title, removed pathway_type/generation_prompt/is_active, added overview_summary and application_timeline"
        },
        "pathway_milestones": {
          "columns": ["id", "pathway_id", "month", "title", "description", "category", "priority", "status", "completed_at"],
          "note": "Renamed milestone_month→month, milestone_type→category, removed milestone_year/order_index/completion_notes, added priority"
        },
        "subject_grade_targets": {
          "columns": ["id", "pathway_id", "subject_name", "current_level", "target_grade", "key_focus_areas"],
          "note": "Renamed current_grade→current_level, removed current_percentage/target_percentage/priority/notes, added key_focus_areas (JSON)"
        },
        "pathway_regeneration_history": {
          "columns": ["id", "goal_id", "old_pathway_id", "new_pathway_id", "reason", "reason_type", "regenerated_at"],
          "note": "Complete schema redesign: now tracks goal_id instead of pathway_id, records old and new pathway IDs for replanning history"
        }
      },
      "migration": {
        "from": 11,
        "steps": [
          {
            "action": "add_column",
            "table": "brainstorm_nodes",
            "sql": "ALTER TABLE brainstorm_nodes ADD COLUMN is_root INTEGER DEFAULT 0"
          },
          {
            "action": "add_column",
            "table": "career_goals",
            "sql": "ALTER TABLE career_goals ADD COLUMN required_subjects TEXT"
          },
          {
            "action": "recreate_table",
            "table": "pathways",
            "description": "Recreate pathways table with correct columns",
            "steps": [
              "CREATE TABLE pathways_new (id INTEGER PRIMARY KEY AUTOINCREMENT, goal_id INTEGER NOT NULL, title TEXT NOT NULL, overview_summary TEXT, application_timeline TEXT, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (goal_id) REFERENCES career_goals(id) ON DELETE CASCADE)",
              "INSERT INTO pathways_new (id, goal_id, title, created_at, updated_at) SELECT id, goal_id, pathway_name, created_at, updated_at FROM pathways",
              "DROP TABLE pathways",
              "ALTER TABLE pathways_new RENAME TO pathways",
              "CREATE INDEX IF NOT EXISTS idx_pathways_goal_id ON pathways(goal_id)"
            ]
          },
          {
            "action": "recreate_table",
            "table": "pathway_milestones",
            "description": "Recreate pathway_milestones table with correct columns",
            "steps": [
              "CREATE TABLE pathway_milestones_new (id INTEGER PRIMARY KEY AUTOINCREMENT, pathway_id INTEGER NOT NULL, month TEXT NOT NULL, title TEXT NOT NULL, description TEXT NOT NULL, category TEXT, priority TEXT, status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'in_progress', 'completed', 'failed', 'skipped')), completed_at INTEGER, FOREIGN KEY (pathway_id) REFERENCES pathways(id) ON DELETE CASCADE)",
              "INSERT INTO pathway_milestones_new (id, pathway_id, month, title, description, status, completed_at) SELECT id, pathway_id, CAST(milestone_month AS TEXT), title, description, status, completed_at FROM pathway_milestones",
              "DROP TABLE pathway_milestones",
              "ALTER TABLE pathway_milestones_new RENAME TO pathway_milestones",
              "CREATE INDEX IF NOT EXISTS idx_pathway_milestones_pathway_id ON pathway_milestones(pathway_id)"
            ]
          },
          {
            "action": "recreate_table",
            "table": "subject_grade_targets",
            "description": "Recreate subject_grade_targets table with correct columns",
            "steps": [
              "CREATE TABLE subject_grade_targets_new (id INTEGER PRIMARY KEY AUTOINCREMENT, pathway_id INTEGER NOT NULL, subject_name TEXT NOT NULL, current_level TEXT, target_grade TEXT NOT NULL, key_focus_areas TEXT, FOREIGN KEY (pathway_id) REFERENCES pathways(id) ON DELETE CASCADE)",
              "INSERT INTO subject_grade_targets_new (id, pathway_id, subject_name, current_level, target_grade) SELECT id, pathway_id, subject_name, current_grade, target_grade FROM subject_grade_targets",
              "DROP TABLE subject_grade_targets",
              "ALTER TABLE subject_grade_targets_new RENAME TO subject_grade_targets",
              "CREATE INDEX IF NOT EXISTS idx_subject_grade_targets_pathway_id ON subject_grade_targets(pathway_id)"
            ]
          },
          {
            "action": "recreate_table",
            "table": "pathway_regeneration_history",
            "description": "Recreate pathway_regeneration_history table with completely new schema",
            "steps": [
              "DROP TABLE pathway_regeneration_history",
              "CREATE TABLE pathway_regeneration_history (id INTEGER PRIMARY KEY AUTOINCREMENT, goal_id INTEGER NOT NULL, old_pathway_id INTEGER, new_pathway_id INTEGER NOT NULL, reason TEXT NOT NULL, reason_type TEXT, regenerated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (goal_id) REFERENCES career_goals(id) ON DELETE CASCADE)",
              "CREATE INDEX IF NOT EXISTS idx_pathway_regeneration_history_goal_id ON pathway_regeneration_history(goal_id)"
            ]
          }
        ]
      }
    },
    "13": {
      "description": "Add user_interests to career_sessions for better AI recommendations on both explore and direct paths",
      "schema": {
        "career_sessions": {
          "columns": ["id", "user_id", "session_type", "user_interests", "cv_file_path", "cv_parsed_data", "current_school", "current_year_group", "target_application_year", "use_exammer_data", "brainstorm_complete", "created_at", "updated_at"],
          "note": "Added user_interests column to store user's academic interests for both explore and direct session types"
        }
      },
      "migration": {
        "from": 12,
        "steps": [
          {
            "action": "add_column",
            "table": "career_sessions",
            "sql": "ALTER TABLE career_sessions ADD COLUMN user_interests TEXT"
          }
        ]
      }
    },
    "14": {
      "description": "Add academic_profile to career_sessions for storing detailed subject and grade information",
      "schema": {
        "career_sessions": {
          "columns": ["id", "user_id", "session_type", "user_interests", "academic_profile", "academic_profile_complete", "cv_file_path", "cv_parsed_data", "current_school", "current_year_group", "target_application_year", "use_exammer_data", "brainstorm_complete", "created_at", "updated_at"],
          "note": "Added academic_profile (JSON) and academic_profile_complete flag"
        }
      },
      "migration": {
        "from": 13,
        "steps": [
          {
            "action": "add_column",
            "table": "career_sessions",
            "sql": "ALTER TABLE career_sessions ADD COLUMN academic_profile TEXT"
          },
          {
            "action": "add_column",
            "table": "career_sessions",
            "sql": "ALTER TABLE career_sessions ADD COLUMN academic_profile_complete INTEGER DEFAULT 0"
          }
        ]
      }
    },
    "15": {
      "description": "Fix brainstorm_nodes unique constraint - change from global node_id unique to composite (session_id, node_id) unique",
      "schema": {
        "brainstorm_nodes": {
          "columns": ["id", "session_id", "node_id", "parent_node_id", "label", "level", "selected", "is_root", "position_x", "position_y", "created_at"],
          "note": "Changed UNIQUE constraint to (session_id, node_id)"
        }
      },
      "migration": {
        "from": 14,
        "steps": [
          {
            "action": "recreate_table",
            "table": "brainstorm_nodes",
            "description": "Recreate brainstorm_nodes with correct unique constraint",
            "steps": [
              "CREATE TABLE brainstorm_nodes_new (id INTEGER PRIMARY KEY AUTOINCREMENT, session_id INTEGER NOT NULL, node_id TEXT NOT NULL, parent_node_id TEXT, label TEXT NOT NULL, level INTEGER NOT NULL DEFAULT 0, selected INTEGER DEFAULT 0, is_root INTEGER DEFAULT 0, position_x REAL NOT NULL, position_y REAL NOT NULL, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (session_id) REFERENCES career_sessions(id) ON DELETE CASCADE, UNIQUE(session_id, node_id))",
              "INSERT INTO brainstorm_nodes_new SELECT * FROM brainstorm_nodes",
              "DROP TABLE brainstorm_nodes",
              "ALTER TABLE brainstorm_nodes_new RENAME TO brainstorm_nodes",
              "CREATE INDEX IF NOT EXISTS idx_brainstorm_nodes_session_id ON brainstorm_nodes(session_id)",
              "CREATE INDEX IF NOT EXISTS idx_brainstorm_nodes_parent ON brainstorm_nodes(parent_node_id)"
            ]
          }
        ]
      }
    }
  }
}
