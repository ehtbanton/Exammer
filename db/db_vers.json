{
  "currentVersion": 4,
  "versions": {
    "0": {
      "description": "Initial schema - subjects owned by users",
      "schema": {
        "subjects": {
          "columns": ["id", "user_id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are tied to users via user_id foreign key"
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions"
        }
      }
    },
    "1": {
      "description": "Workspace architecture - subjects are public, users have workspaces",
      "schema": {
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are standalone content, not tied to users. All subjects are publicly accessible."
        },
        "user_workspaces": {
          "columns": ["id", "user_id", "subject_id", "is_creator", "added_at"],
          "note": "Links users to subjects in their workspace. is_creator=1 means user created this subject."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions (unchanged)"
        }
      },
      "migration": {
        "from": 0,
        "steps": [
          {
            "action": "create_table",
            "table": "user_workspaces",
            "sql": "CREATE TABLE IF NOT EXISTS user_workspaces (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, is_creator INTEGER DEFAULT 0, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, UNIQUE(user_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_user_id ON user_workspaces(user_id)"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_subject_id ON user_workspaces(subject_id)"
          },
          {
            "action": "migrate_data",
            "description": "Migrate existing subjects to workspace model - create workspace entries for subject creators",
            "sql": "INSERT INTO user_workspaces (user_id, subject_id, is_creator, added_at) SELECT user_id, id, 1, created_at FROM subjects"
          },
          {
            "action": "drop_column_simulation",
            "description": "SQLite doesn't support DROP COLUMN directly, so we recreate the table",
            "steps": [
              "CREATE TABLE subjects_new (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, syllabus_content TEXT, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()))",
              "INSERT INTO subjects_new (id, name, syllabus_content, created_at, updated_at) SELECT id, name, syllabus_content, created_at, updated_at FROM subjects",
              "DROP TABLE subjects",
              "ALTER TABLE subjects_new RENAME TO subjects"
            ]
          },
          {
            "action": "recreate_indexes",
            "description": "Recreate indexes after table recreation",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_name ON subjects(name)"
          }
        ]
      }
    },
    "2": {
      "description": "Add score_history to user_progress for last-3-scores averaging with 50% starting score",
      "schema": {
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "updated_at"],
          "note": "score_history stores JSON array of last 3 scores (out of 10). Default starting score is 50%, averaging with last 3 attempts."
        }
      },
      "migration": {
        "from": 1,
        "steps": [
          {
            "action": "create_table",
            "description": "Add score_history column to user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN score_history TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "3": {
      "description": "Markscheme-based objective tracking system - adds markschemes table, solution objectives to questions, and completed objectives tracking",
      "schema": {
        "markschemes": {
          "columns": ["id", "subject_id", "name", "content", "created_at"],
          "note": "Stores markscheme files for papers, used to extract solution objectives"
        },
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "created_at"],
          "note": "solution_objectives stores JSON array of marking criteria/objectives. markscheme_id references the source markscheme."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "completed_objectives", "updated_at"],
          "note": "completed_objectives stores JSON array of objective indices that user has achieved. Once set, objectives cannot be removed (immutable progress)."
        }
      },
      "migration": {
        "from": 2,
        "steps": [
          {
            "action": "create_table",
            "table": "markschemes",
            "sql": "CREATE TABLE IF NOT EXISTS markschemes (id INTEGER PRIMARY KEY AUTOINCREMENT, subject_id INTEGER NOT NULL, name TEXT NOT NULL, content TEXT NOT NULL, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "markschemes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_markschemes_subject_id ON markschemes(subject_id)"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN solution_objectives TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN markscheme_id INTEGER REFERENCES markschemes(id) ON DELETE SET NULL"
          },
          {
            "action": "add_column",
            "table": "user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN completed_objectives TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "4": {
      "description": "Add paper_date and question_number to questions for separate paper/markscheme workflow",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "created_at"],
          "note": "paper_date stores exam date (e.g., '2022-06'), question_number stores question identifier (e.g., '1-3-5')"
        }
      },
      "migration": {
        "from": 3,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN paper_date TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN question_number TEXT"
          }
        ]
      }
    }
  }
}
