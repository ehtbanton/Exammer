{
  "currentVersion": 11,
  "versions": {
    "0": {
      "description": "Initial schema - subjects owned by users",
      "schema": {
        "subjects": {
          "columns": ["id", "user_id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are tied to users via user_id foreign key"
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions"
        }
      }
    },
    "1": {
      "description": "Workspace architecture - subjects are public, users have workspaces",
      "schema": {
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are standalone content, not tied to users. All subjects are publicly accessible."
        },
        "user_workspaces": {
          "columns": ["id", "user_id", "subject_id", "is_creator", "added_at"],
          "note": "Links users to subjects in their workspace. is_creator=1 means user created this subject."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions (unchanged)"
        }
      },
      "migration": {
        "from": 0,
        "steps": [
          {
            "action": "create_table",
            "table": "user_workspaces",
            "sql": "CREATE TABLE IF NOT EXISTS user_workspaces (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, is_creator INTEGER DEFAULT 0, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, UNIQUE(user_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_user_id ON user_workspaces(user_id)"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_subject_id ON user_workspaces(subject_id)"
          },
          {
            "action": "migrate_data",
            "description": "Migrate existing subjects to workspace model - create workspace entries for subject creators",
            "sql": "INSERT INTO user_workspaces (user_id, subject_id, is_creator, added_at) SELECT user_id, id, 1, created_at FROM subjects"
          },
          {
            "action": "drop_column_simulation",
            "description": "SQLite doesn't support DROP COLUMN directly, so we recreate the table",
            "steps": [
              "CREATE TABLE subjects_new (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, syllabus_content TEXT, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()))",
              "INSERT INTO subjects_new (id, name, syllabus_content, created_at, updated_at) SELECT id, name, syllabus_content, created_at, updated_at FROM subjects",
              "DROP TABLE subjects",
              "ALTER TABLE subjects_new RENAME TO subjects"
            ]
          },
          {
            "action": "recreate_indexes",
            "description": "Recreate indexes after table recreation",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_name ON subjects(name)"
          }
        ]
      }
    },
    "2": {
      "description": "Add score_history to user_progress for last-3-scores averaging with 50% starting score",
      "schema": {
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "updated_at"],
          "note": "score_history stores JSON array of last 3 scores (out of 10). Default starting score is 50%, averaging with last 3 attempts."
        }
      },
      "migration": {
        "from": 1,
        "steps": [
          {
            "action": "create_table",
            "description": "Add score_history column to user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN score_history TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "3": {
      "description": "Markscheme-based objective tracking system - adds markschemes table, solution objectives to questions, and completed objectives tracking",
      "schema": {
        "markschemes": {
          "columns": ["id", "subject_id", "name", "content", "created_at"],
          "note": "Stores markscheme files for papers, used to extract solution objectives"
        },
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "created_at"],
          "note": "solution_objectives stores JSON array of marking criteria/objectives. markscheme_id references the source markscheme."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "score_history", "completed_objectives", "updated_at"],
          "note": "completed_objectives stores JSON array of objective indices that user has achieved. Once set, objectives cannot be removed (immutable progress)."
        }
      },
      "migration": {
        "from": 2,
        "steps": [
          {
            "action": "create_table",
            "table": "markschemes",
            "sql": "CREATE TABLE IF NOT EXISTS markschemes (id INTEGER PRIMARY KEY AUTOINCREMENT, subject_id INTEGER NOT NULL, name TEXT NOT NULL, content TEXT NOT NULL, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "markschemes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_markschemes_subject_id ON markschemes(subject_id)"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN solution_objectives TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN markscheme_id INTEGER REFERENCES markschemes(id) ON DELETE SET NULL"
          },
          {
            "action": "add_column",
            "table": "user_progress",
            "sql": "ALTER TABLE user_progress ADD COLUMN completed_objectives TEXT DEFAULT '[]'"
          }
        ]
      }
    },
    "4": {
      "description": "Add paper_date and question_number to questions for separate paper/markscheme workflow",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "created_at"],
          "note": "paper_date stores exam date (e.g., '2022-06'), question_number stores question identifier (e.g., '1-3-5')"
        }
      },
      "migration": {
        "from": 3,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN paper_date TEXT"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN question_number TEXT"
          }
        ]
      }
    },
    "5": {
      "description": "Teacher-student class system - adds classes, class memberships, and class-subject assignments",
      "schema": {
        "classes": {
          "columns": ["id", "name", "description", "teacher_id", "classroom_code", "created_at", "updated_at"],
          "note": "Classes created by teachers with unique 6-character codes"
        },
        "class_memberships": {
          "columns": ["id", "class_id", "user_id", "role", "status", "joined_at"],
          "note": "Tracks teacher/student membership in classes with pending/approved/rejected status"
        },
        "class_subjects": {
          "columns": ["id", "class_id", "subject_id", "added_by_user_id", "added_at"],
          "note": "Links subjects to classes so students can access them"
        },
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "class_id", "created_at", "updated_at"],
          "note": "Subjects can optionally belong to a specific class (class_id)"
        }
      },
      "migration": {
        "from": 4,
        "steps": [
          {
            "action": "create_table",
            "table": "classes",
            "sql": "CREATE TABLE IF NOT EXISTS classes (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, description TEXT, teacher_id INTEGER NOT NULL, classroom_code TEXT UNIQUE NOT NULL, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (teacher_id) REFERENCES users(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "classes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_classes_teacher_id ON classes(teacher_id)"
          },
          {
            "action": "create_index",
            "table": "classes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_classes_classroom_code ON classes(classroom_code)"
          },
          {
            "action": "create_table",
            "table": "class_memberships",
            "sql": "CREATE TABLE IF NOT EXISTS class_memberships (id INTEGER PRIMARY KEY AUTOINCREMENT, class_id INTEGER NOT NULL, user_id INTEGER NOT NULL, role TEXT NOT NULL CHECK(role IN ('teacher', 'student')), status TEXT NOT NULL CHECK(status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending', joined_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, UNIQUE(class_id, user_id))"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_class_id ON class_memberships(class_id)"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_user_id ON class_memberships(user_id)"
          },
          {
            "action": "create_index",
            "table": "class_memberships",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_memberships_status ON class_memberships(status)"
          },
          {
            "action": "create_table",
            "table": "class_subjects",
            "sql": "CREATE TABLE IF NOT EXISTS class_subjects (id INTEGER PRIMARY KEY AUTOINCREMENT, class_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, added_by_user_id INTEGER NOT NULL, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, FOREIGN KEY (added_by_user_id) REFERENCES users(id) ON DELETE CASCADE, UNIQUE(class_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "class_subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_subjects_class_id ON class_subjects(class_id)"
          },
          {
            "action": "create_index",
            "table": "class_subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_class_subjects_subject_id ON class_subjects(subject_id)"
          },
          {
            "action": "add_column",
            "table": "subjects",
            "sql": "ALTER TABLE subjects ADD COLUMN class_id INTEGER DEFAULT NULL"
          },
          {
            "action": "create_index",
            "table": "subjects",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_class_id ON subjects(class_id)"
          }
        ]
      }
    },
    "6": {
      "description": "Add diagram_mermaid to questions for mermaid diagram support",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "diagram_mermaid", "created_at"],
          "note": "diagram_mermaid stores mermaid diagram syntax for rendering diagrams"
        }
      },
      "migration": {
        "from": 5,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN diagram_mermaid TEXT"
          }
        ]
      }
    },
    "7": {
      "description": "Add categorization confidence and reasoning for improved paper categorization accuracy",
      "schema": {
        "questions": {
          "columns": ["id", "topic_id", "question_text", "summary", "solution_objectives", "markscheme_id", "paper_date", "question_number", "diagram_mermaid", "categorization_confidence", "categorization_reasoning", "created_at"],
          "note": "categorization_confidence stores confidence score (0-100) for AI categorization decisions, categorization_reasoning stores brief explanation"
        }
      },
      "migration": {
        "from": 6,
        "steps": [
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN categorization_confidence INTEGER DEFAULT 100"
          },
          {
            "action": "add_column",
            "table": "questions",
            "sql": "ALTER TABLE questions ADD COLUMN categorization_reasoning TEXT"
          }
        ]
      }
    },
    "8": {
      "description": "Add user feedback system with admin dashboard",
      "schema": {
        "feedback": {
          "columns": ["id", "user_id", "category", "title", "description", "url", "screenshot_url", "browser_info", "status", "priority", "created_at", "updated_at", "resolved_at"],
          "note": "Main feedback table storing bug reports, feature requests, and user inquiries. Supports anonymous and authenticated users."
        },
        "feedback_notes": {
          "columns": ["id", "feedback_id", "admin_user_id", "note", "is_internal", "created_at"],
          "note": "Admin notes on feedback items. is_internal=1 hides note from users."
        },
        "feedback_status_history": {
          "columns": ["id", "feedback_id", "admin_user_id", "old_status", "new_status", "changed_at"],
          "note": "Tracks all status changes for feedback items for audit trail."
        }
      },
      "migration": {
        "from": 7,
        "steps": [
          {
            "action": "create_table",
            "table": "feedback",
            "sql": "CREATE TABLE IF NOT EXISTS feedback (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, category TEXT NOT NULL CHECK(category IN ('bug', 'feature', 'improvement', 'question', 'other')), title TEXT NOT NULL, description TEXT NOT NULL, url TEXT, screenshot_url TEXT, browser_info TEXT, status TEXT NOT NULL DEFAULT 'new' CHECK(status IN ('new', 'in_progress', 'resolved', 'closed', 'archived')), priority TEXT DEFAULT 'medium' CHECK(priority IN ('low', 'medium', 'high', 'critical')), created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()), resolved_at INTEGER, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_user_id ON feedback(user_id)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_status ON feedback(status)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_category ON feedback(category)"
          },
          {
            "action": "create_index",
            "table": "feedback",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_created_at ON feedback(created_at)"
          },
          {
            "action": "create_table",
            "table": "feedback_notes",
            "sql": "CREATE TABLE IF NOT EXISTS feedback_notes (id INTEGER PRIMARY KEY AUTOINCREMENT, feedback_id INTEGER NOT NULL, admin_user_id INTEGER NOT NULL, note TEXT NOT NULL, is_internal BOOLEAN DEFAULT 1, created_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE, FOREIGN KEY (admin_user_id) REFERENCES users(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "feedback_notes",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_notes_feedback_id ON feedback_notes(feedback_id)"
          },
          {
            "action": "create_table",
            "table": "feedback_status_history",
            "sql": "CREATE TABLE IF NOT EXISTS feedback_status_history (id INTEGER PRIMARY KEY AUTOINCREMENT, feedback_id INTEGER NOT NULL, admin_user_id INTEGER, old_status TEXT, new_status TEXT NOT NULL, changed_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE, FOREIGN KEY (admin_user_id) REFERENCES users(id) ON DELETE SET NULL)"
          },
          {
            "action": "create_index",
            "table": "feedback_status_history",
            "sql": "CREATE INDEX IF NOT EXISTS idx_feedback_status_history_feedback_id ON feedback_status_history(feedback_id)"
          }
        ]
      }
    },
    "9": {
      "description": "Transition version - no migration needed (feedback system already applied)",
      "schema": {},
      "migration": {
        "from": 8,
        "steps": []
      }
    },
    "10": {
      "description": "Add email verification system - replaces manual approval with automated email verification",
      "schema": {
        "users": {
          "columns": ["id", "name", "email", "email_verified", "image", "access_level", "email_verification_sent_at", "created_at", "updated_at"],
          "note": "email_verification_sent_at stores timestamp of last verification email sent (for rate limiting)"
        }
      },
      "migration": {
        "from": 9,
        "steps": [
          {
            "action": "add_column",
            "table": "users",
            "sql": "ALTER TABLE users ADD COLUMN email_verification_sent_at INTEGER DEFAULT NULL"
          }
        ]
      }
    },
    "11": {
      "description": "Add conversation storage for RAG search - stores interview conversations with embeddings for semantic search",
      "schema": {
        "conversations": {
          "columns": ["id", "user_id", "question_id", "started_at", "ended_at", "final_score", "summary", "summary_embedding"],
          "note": "Stores interview sessions. summary is AI-generated, summary_embedding is JSON array of 768 floats for semantic search."
        },
        "conversation_messages": {
          "columns": ["id", "conversation_id", "role", "content", "image_url", "created_at"],
          "note": "Individual messages in a conversation. role is 'user' or 'assistant'. image_url stores whiteboard images."
        }
      },
      "migration": {
        "from": 10,
        "steps": [
          {
            "action": "create_table",
            "table": "conversations",
            "sql": "CREATE TABLE IF NOT EXISTS conversations (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, question_id INTEGER NOT NULL, started_at INTEGER NOT NULL DEFAULT (unixepoch()), ended_at INTEGER, final_score INTEGER, summary TEXT, summary_embedding TEXT, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "conversations",
            "sql": "CREATE INDEX IF NOT EXISTS idx_conversations_user_id ON conversations(user_id)"
          },
          {
            "action": "create_index",
            "table": "conversations",
            "sql": "CREATE INDEX IF NOT EXISTS idx_conversations_question_id ON conversations(question_id)"
          },
          {
            "action": "create_index",
            "table": "conversations",
            "sql": "CREATE INDEX IF NOT EXISTS idx_conversations_started_at ON conversations(started_at)"
          },
          {
            "action": "create_table",
            "table": "conversation_messages",
            "sql": "CREATE TABLE IF NOT EXISTS conversation_messages (id INTEGER PRIMARY KEY AUTOINCREMENT, conversation_id INTEGER NOT NULL, role TEXT NOT NULL CHECK(role IN ('user', 'assistant')), content TEXT NOT NULL, image_url TEXT, created_at INTEGER NOT NULL DEFAULT (unixepoch()), FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE)"
          },
          {
            "action": "create_index",
            "table": "conversation_messages",
            "sql": "CREATE INDEX IF NOT EXISTS idx_conversation_messages_conversation_id ON conversation_messages(conversation_id)"
          }
        ]
      }
    }
  }
}
