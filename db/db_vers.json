{
  "currentVersion": 1,
  "versions": {
    "0": {
      "description": "Initial schema - subjects owned by users",
      "schema": {
        "subjects": {
          "columns": ["id", "user_id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are tied to users via user_id foreign key"
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions"
        }
      }
    },
    "1": {
      "description": "Workspace architecture - subjects are public, users have workspaces",
      "schema": {
        "subjects": {
          "columns": ["id", "name", "syllabus_content", "created_at", "updated_at"],
          "note": "Subjects are standalone content, not tied to users. All subjects are publicly accessible."
        },
        "user_workspaces": {
          "columns": ["id", "user_id", "subject_id", "is_creator", "added_at"],
          "note": "Links users to subjects in their workspace. is_creator=1 means user created this subject."
        },
        "user_progress": {
          "columns": ["id", "user_id", "question_id", "score", "attempts", "updated_at"],
          "note": "User progress on questions (unchanged)"
        }
      },
      "migration": {
        "from": 0,
        "steps": [
          {
            "action": "create_table",
            "table": "user_workspaces",
            "sql": "CREATE TABLE IF NOT EXISTS user_workspaces (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, is_creator INTEGER DEFAULT 0, added_at INTEGER DEFAULT (unixepoch()), FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE, UNIQUE(user_id, subject_id))"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_user_id ON user_workspaces(user_id)"
          },
          {
            "action": "create_index",
            "table": "user_workspaces",
            "sql": "CREATE INDEX IF NOT EXISTS idx_user_workspaces_subject_id ON user_workspaces(subject_id)"
          },
          {
            "action": "migrate_data",
            "description": "Migrate existing subjects to workspace model - create workspace entries for subject creators",
            "sql": "INSERT INTO user_workspaces (user_id, subject_id, is_creator, added_at) SELECT user_id, id, 1, created_at FROM subjects"
          },
          {
            "action": "drop_column_simulation",
            "description": "SQLite doesn't support DROP COLUMN directly, so we recreate the table",
            "steps": [
              "CREATE TABLE subjects_new (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, syllabus_content TEXT, created_at INTEGER DEFAULT (unixepoch()), updated_at INTEGER DEFAULT (unixepoch()))",
              "INSERT INTO subjects_new (id, name, syllabus_content, created_at, updated_at) SELECT id, name, syllabus_content, created_at, updated_at FROM subjects",
              "DROP TABLE subjects",
              "ALTER TABLE subjects_new RENAME TO subjects"
            ]
          },
          {
            "action": "recreate_indexes",
            "description": "Recreate indexes after table recreation",
            "sql": "CREATE INDEX IF NOT EXISTS idx_subjects_name ON subjects(name)"
          }
        ]
      }
    }
  }
}
